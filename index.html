<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NotPX: Drawing</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="coordsByColors.js"></script>
    <script src="pixi.js"></script>
    <script src="viewport.min.js"></script>
    <link rel="stylesheet" href="styles.css" />
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const pixelSize = 1;
            const startX = 0;
            const startY = 500;
            const imageSize = 40 * pixelSize;
            const verticalImages = 1;
            const horizontalImages = 2;
            let previousCoords = [0, 0];
            let zoomThreshold = 0.7;

            const app = new PIXI.Application({
                background: 0xdddddd,
                width: window.innerWidth,
                height: window.innerHeight,
            });
            document.body.appendChild(app.view);

            const viewport = new pixi_viewport.Viewport({
                screenWidth: window.innerWidth,
                screenHeight: window.innerHeight,
                worldWidth: imageSize * horizontalImages,
                worldHeight: imageSize * verticalImages,
                events: app.renderer.events.interaction,
            });

            // add the viewport to the stage
            app.stage.addChild(viewport);

            // activate plugins
            viewport.drag().pinch().wheel();
            let pixels = {};
            const basePixel = new PIXI.Sprite(PIXI.Texture.WHITE); // A white texture that can be tinted
            basePixel.width = pixelSize;
            basePixel.height = pixelSize;

            let eggs = [
                { startX: 0, startY: 0, background: "#000000", border: "#FFFFFF", main: "#FFB471", shadow: "#9E6924" },
                { startX: 40, startY: 0, background: "#FF3981", border: "#FFFFFF", main: "#FFB471", shadow: "#9E6924" }
            ];

            for (let index = 0; index < eggs.length; index++) {
                const egg = eggs[index];
                for (let i = 0; i < backgroundCoords.length; i++) {
                    drawPixel(egg.startX + backgroundCoords[i][0], egg.startY + backgroundCoords[i][1], egg, egg.background);
                }
                for (let i = 0; i < mainCoords.length; i++) {
                    drawPixel(egg.startX + mainCoords[i][0], egg.startY + mainCoords[i][1], egg, egg.main);
                }
                for (let i = 0; i < borderCoords.length; i++) {
                    drawPixel(egg.startX + borderCoords[i][0], egg.startY + borderCoords[i][1], egg, egg.border);
                }
                for (let i = 0; i < shadowCoords.length; i++) {
                    drawPixel(egg.startX + shadowCoords[i][0], egg.startY + shadowCoords[i][1], egg, egg.shadow);
                }
            }

            function drawPixel(x, y, egg, color) {
                console.log(egg)
                const pixel = viewport.addChild(new PIXI.Sprite(basePixel.texture));

                pixel.width = pixelSize;
                pixel.height = pixelSize;

                // Set position of the pixel
                pixel.x = x * pixelSize;
                pixel.y = y * pixelSize;

                // Apply tint color from jsonData
                pixel.tint = color;
                pixel.originalTint = color;
                pixel.egg = egg;
                pixels[`${x}_${y}`] = pixel;
            }

            viewport.fit();
            viewport.on("clicked", function (e) {
                Object.values(pixels).forEach((p) => {
                    if (p.isActive) {
                        p.tint = p.originalTint;
                        p.isActive = false;
                    }
                });

                const x = Math.floor(e.world.x / pixelSize);
                const y = Math.floor(e.world.y / pixelSize);
                const pixel = pixels[`${x}_${y}`];

                pixel.isActive = true;
                pixel.tint = 0x39FFEC;

                showPopup(x, y, pixel.egg);
            });

            function showPopup(x, y, egg) {
                let popup = document.getElementById("popup");
                if (!popup) {
                    popup = document.createElement("div");
                    popup.id = "popup";
                    document.body.appendChild(popup);
                }

                const shiftedX = startX  + x;
                const shiftedY = startY + y;

                const h = Math.abs(previousCoords[0] - shiftedX);
                const v = Math.abs(previousCoords[1] - shiftedY);

                const link = `https://t.me/notpixel/app?startapp=x${shiftedX}_y${shiftedY}`;

                popup.innerHTML = `
            <a href="${link}" target="_blank" rel="noopener noreferrer" class="open-btn">Open app</a><br/>
            Coords: ${shiftedX}-${shiftedY}<br/>
            Distance:<br/>
            Vertical - ${v > 0 ? v + 1 : 0}<br/>
            Horizontal - ${h > 0 ? h + 1 : 0}
          `;
                previousCoords = [shiftedX, shiftedY];
            }
        });
    </script>
</head>

<body>
    <div style="padding: 10px; position: fixed; background: white;"><a
            href="template.html" target="_blank">Инструкция по
            установке шаблона</a></div>
</body>

</html>